# {{ ansible_managed }}
# Prometheus Alert rules
# https://thenewstack.io/contributing-prometheus-history-alertmanager/
# https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/

groups:

- name: default instance down rules
  rules:

  - alert: instance_down
    expr: up == 0
    for: {{ prometheus_alertmanager_instance_down_warn }}
    labels:
      severity: warn
    annotations:
{% raw %}
      summary: "Instance {{$labels.instance}} may be down"
      description: "{{$labels.instance}} of job {{$labels.job}} has been down for more than {% endraw -%} {{ prometheus_alertmanager_instance_down_warn }}."

  - alert: instance_down
    expr: up == 0
    for: {{ prometheus_alertmanager_instance_down_error }}
    labels:
      severity: error
    annotations:
{% raw %}
      summary: "Instance {{$labels.instance}} down"
      description: "{{$labels.instance}} of job {{$labels.job}} has been down for more than {% endraw -%} {{ prometheus_alertmanager_instance_down_error }}."

  - alert: BlackboxProbeFailed
    expr: probe_success == 0
    for: 0m
    labels:
      severity: error
    annotations:
{% raw %}
      summary: "Blackbox probe failed (instance {{ $labels.instance }})"
      description: "Probe failed\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}{% endraw -%}"

  - alert: BlackboxSlowProbe
    expr: avg_over_time(probe_duration_seconds[1m]) > 1
    for: 1m
    labels:
      severity: warn
    annotations:
{% raw %}
      summary: "Blackbox slow probe (instance {{ $labels.instance }})"
      description: "Blackbox probe took more than 1s to complete\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}{% endraw -%}"

- name: SSL rules
  rules:
  - alert: SSLCertExpiringSoon
    expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 4
    for: 1m
    labels:
      severity: warning
    annotations:
{% raw %}
      summary: "TLS certificate for (instance {{ $labels.instance }}) about to expire"
      description: "TLS certificate will expire in {{ $value | humanizeDuration }} (instance {{ $labels.instance }}){% endraw -%}"

